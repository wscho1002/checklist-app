<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë‚˜ë§Œì˜ ë•ì§ˆ ì²´í¬ë¦¬ìŠ¤íŠ¸</title>
  <style>
    body { font-family: sans-serif; margin: 20px; }
    .view { display: none; }
    .active { display: block; }
    button { padding: 10px; margin-top: 10px; }
    img { max-width: 100%; height: auto; }
    #itemList img { width: 50px; height: 50px; vertical-align: middle; }
    #memoModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.8); z-index:1000; justify-content:center; align-items:center; flex-direction:column; }
  </style>
</head>
<body>

  <!-- ë©”ì¸ í™”ë©´ -->
  <div id="mainView" class="view active">
    <h1>ğŸ“‹ ë‚˜ë§Œì˜ ì²´í¬ë¦¬ìŠ¤íŠ¸</h1>
    <button onclick="showCreateView()">+ ìƒˆ ì²´í¬ë¦¬ìŠ¤íŠ¸ ë§Œë“¤ê¸°</button>
    <button onclick="downloadBackup()" style="margin-left: 10px;">ğŸ’¾ ë°±ì—…í•˜ê¸°</button>
    <input type="file" id="backupFileInput" style="display:none;" onchange="uploadBackup(event)">
    <button onclick="document.getElementById('backupFileInput').click()" style="margin-left: 10px;">ğŸ“‚ ë¶ˆëŸ¬ì˜¤ê¸°</button>
    <div id="checklistList"></div>
  </div>
  

  <!-- ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„± í™”ë©´ -->
  <div id="createView" class="view">
    <h1>ğŸ› ï¸ ì²´í¬ë¦¬ìŠ¤íŠ¸ ë§Œë“¤ê¸°</h1>
    <input type="text" id="titleInput" placeholder="ì²´í¬ë¦¬ìŠ¤íŠ¸ ì œëª©"><br>
    <input type="text" id="descInput" placeholder="ì„¤ëª… (ì„ íƒì‚¬í•­)"><br><br>
    <label>ì»¤ë²„ ì´ë¯¸ì§€ ì„ íƒ:</label><br>
    <input type="file" id="coverImageInput"><br><br>
    <h2>í•­ëª© ì¶”ê°€</h2>
    <input type="text" id="itemNameInput" placeholder="í•­ëª© ì´ë¦„">
    <input type="file" id="itemImageInput">
    <button onclick="addItem()">í•­ëª© ì¶”ê°€</button>
    <ul id="itemList"></ul>
    <button onclick="saveChecklist()">ì²´í¬ë¦¬ìŠ¤íŠ¸ ì €ì¥í•˜ê¸°</button>
    <button onclick="showMainView()">â† ë©”ì¸ìœ¼ë¡œ</button>
  </div>

  <!-- ì²´í¬ë¦¬ìŠ¤íŠ¸ ìƒì„¸ í™”ë©´ -->
<div id="detailView" class="view">
    <h1 id="detailTitle"></h1>
    <img id="detailCover"><br>
    <p id="detailDesc"></p>
    <p id="progressText" style="font-weight: bold; font-size: 18px;"></p>
  
    <div id="taskList" style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px;"></div>
  
    <button onclick="showMainView()">â† ë©”ì¸ìœ¼ë¡œ</button>
    <button onclick="editChecklist()" style="background-color: #4caf50; color: white; margin-top: 10px;">âœï¸ ìˆ˜ì •í•˜ê¸°</button>
  </div>



  <!-- ì´ë¯¸ì§€ í™•ëŒ€ + ë©”ëª¨ ëª¨ë‹¬ -->
  <div id="memoModal">
    <img id="modalImage" style="max-width:90%; max-height:50%; margin-bottom:20px;">
    <textarea id="memoInput" placeholder="ë©”ëª¨ë¥¼ ì…ë ¥í•˜ì„¸ìš”" style="width:80%; height:100px;"></textarea><br>
    <button onclick="saveMemo()">ë©”ëª¨ ì €ì¥</button>
    <button onclick="closeMemoModal()">ë‹«ê¸°</button>
  </div>

<script>
  // í™”ë©´ ì „í™˜
  function showMainView() {
    document.getElementById('mainView').classList.add('active');
    document.getElementById('createView').classList.remove('active');
    document.getElementById('detailView').classList.remove('active');
  }

  function showCreateView() {
    document.getElementById('mainView').classList.remove('active');
    document.getElementById('createView').classList.add('active');
    document.getElementById('detailView').classList.remove('active');
  }

  function showDetailView() {
    document.getElementById('mainView').classList.remove('active');
    document.getElementById('createView').classList.remove('active');
    document.getElementById('detailView').classList.add('active');
  }

  // ë°ì´í„° ì €ì¥
  let items = [];
  let allChecklists = JSON.parse(localStorage.getItem('allChecklists')) || [];
  let currentMemoItem = null;

  function addItem() {
    const itemName = document.getElementById('itemNameInput').value.trim();
    const itemImageInput = document.getElementById('itemImageInput');
    const itemImageFile = itemImageInput.files[0];

    if (itemName === "") {
      alert("í•­ëª© ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
      return;
    }
    if (!itemImageFile) {
      alert("ì´ë¯¸ì§€ë¥¼ ê¼­ ì„ íƒí•´ì£¼ì„¸ìš”!");
      return;
    }

    const reader = new FileReader();
    reader.onload = function(e) {
      const newItem = { name: itemName, image: e.target.result, checked: false, memo: "" };
      items.push(newItem);
      renderItemList();
    };
    reader.readAsDataURL(itemImageFile);

    document.getElementById('itemNameInput').value = "";
    document.getElementById('itemImageInput').value = "";
  }

  function renderItemList() {
  const itemList = document.getElementById('itemList');
  itemList.innerHTML = "";

  items.forEach((item, index) => {
    const li = document.createElement('li');
    li.style.display = "flex";
    li.style.alignItems = "center";
    li.style.gap = "10px";
    li.style.border = "1px solid #ccc";
    li.style.padding = "5px";
    li.style.marginBottom = "5px";
    li.dataset.index = index; // liì— ì¸ë±ìŠ¤ ì €ì¥

    // ì†ì¡ì´
    const handle = document.createElement('div');
    handle.textContent = "â‰¡";
    handle.style.cursor = "grab";
    handle.style.fontSize = "20px";
    handle.style.userSelect = "none";
    handle.style.padding = "5px";
    handle.draggable = true; // ì†ì¡ì´ë§Œ draggable!

    handle.addEventListener('dragstart', function(e) {
      draggedIndex = e.target.parentElement.dataset.index; // ë¶€ëª¨ liì—ì„œ ì¸ë±ìŠ¤ ì°¾ê¸°
    });

    // ë“œë˜ê·¸ ë“œë ê´€ë ¨
    li.addEventListener('dragover', function(e) {
      e.preventDefault(); // drop í—ˆìš©
    });

    li.addEventListener('drop', function(e) {
      const targetIndex = e.target.closest('li').dataset.index;
      if (draggedIndex !== null && targetIndex !== null) {
        const draggedItem = items[draggedIndex];
        items.splice(draggedIndex, 1);
        items.splice(targetIndex, 0, draggedItem);
        renderItemList(); // ìƒˆë¡œ ê·¸ë¦¬ê¸°
      }
      draggedIndex = null;
    });

    // ì¸ë„¤ì¼
    const thumb = document.createElement('img');
    thumb.src = item.image;
    thumb.style.width = "50px";
    thumb.style.height = "50px";
    thumb.style.objectFit = "cover";

    // ì´ë¦„
    const name = document.createElement('span');
    name.textContent = item.name;
    name.style.flex = "1";

    // ì‚­ì œ ë²„íŠ¼
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = "ì‚­ì œ";
    deleteBtn.onclick = function(e) {
      e.stopPropagation();
      items.splice(index, 1);
      renderItemList();
    };

    li.appendChild(handle);
    li.appendChild(thumb);
    li.appendChild(name);
    li.appendChild(deleteBtn);
    itemList.appendChild(li);
  });
}


  let draggedIndex = null;
  function handleDragStart(e) { draggedIndex = e.target.dataset.index; }
  function handleDragOver(e) { e.preventDefault(); }
  function handleDrop(e) {
    const targetIndex = e.target.closest('li').dataset.index;
    if (draggedIndex !== null && targetIndex !== null) {
      const draggedItem = items[draggedIndex];
      items.splice(draggedIndex, 1);
      items.splice(targetIndex, 0, draggedItem);
      renderItemList();
    }
    draggedIndex = null;
  }

  function saveChecklist() {
  const title = document.getElementById('titleInput').value.trim();
  const description = document.getElementById('descInput').value.trim();
  const coverInput = document.getElementById('coverImageInput');
  const coverFile = coverInput.files[0];

  if (title === "") {
    alert("ì²´í¬ë¦¬ìŠ¤íŠ¸ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”!");
    return;
  }

  // ìˆ˜ì •ì¤‘ì´ë¼ë©´
  if (editingChecklistId !== null) {
    const checklistIndex = allChecklists.findIndex(c => c.id === editingChecklistId);
    if (checklistIndex !== -1) {
      const checklist = allChecklists[checklistIndex];
      checklist.title = title;
      checklist.description = description;
      checklist.items = items;

      if (coverFile) {
        const reader = new FileReader();
        reader.onload = function(e) {
          checklist.cover = e.target.result;
          localStorage.setItem('allChecklists', JSON.stringify(allChecklists));
          afterSave();
        };
        reader.readAsDataURL(coverFile);
      } else if (coverPreviewImage) {
        checklist.cover = coverPreviewImage; // ê¸°ì¡´ ì»¤ë²„ ìœ ì§€
        localStorage.setItem('allChecklists', JSON.stringify(allChecklists));
        afterSave();
      } else {
        checklist.cover = null;
        localStorage.setItem('allChecklists', JSON.stringify(allChecklists));
        afterSave();
      }
    }
    editingChecklistId = null; // ìˆ˜ì • ë
    coverPreviewImage = null;
  }
  // ìƒˆ ì²´í¬ë¦¬ìŠ¤íŠ¸ ë§Œë“œëŠ” ê²½ìš°
  else {
    const reader = new FileReader();
    if (coverFile) {
      reader.onload = function(e) {
        const checklist = {
          id: Date.now(),
          title: title,
          description: description,
          cover: e.target.result,
          items: items
        };
        allChecklists.push(checklist);
        localStorage.setItem('allChecklists', JSON.stringify(allChecklists));
        afterSave();
      };
      reader.readAsDataURL(coverFile);
    } else {
      const checklist = {
        id: Date.now(),
        title: title,
        description: description,
        cover: null,
        items: items
      };
      allChecklists.push(checklist);
      localStorage.setItem('allChecklists', JSON.stringify(allChecklists));
      afterSave();
    }
  }
}

function afterSave() {
  resetCreateForm();
  showMainView();
  renderChecklistList();
}


  function deleteChecklist(id) {
  if (confirm("ì´ ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ì‚­ì œí• ê¹Œìš”?")) {
    allChecklists = allChecklists.filter(c => c.id !== id);
    localStorage.setItem('allChecklists', JSON.stringify(allChecklists));
    renderChecklistList();
    alert("ì²´í¬ë¦¬ìŠ¤íŠ¸ê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.");
  }
}

  function resetCreateForm() {
    document.getElementById('titleInput').value = "";
    document.getElementById('descInput').value = "";
    document.getElementById('coverImageInput').value = "";
    document.getElementById('itemNameInput').value = "";
    document.getElementById('itemImageInput').value = "";
    items = [];
    renderItemList();
  }

  function renderChecklistList() {
  const listDiv = document.getElementById('checklistList');
  listDiv.innerHTML = "";

  allChecklists.forEach(checklist => {
    const div = document.createElement('div');
    div.style.border = "1px solid #ccc";
    div.style.padding = "10px";
    div.style.margin = "10px 0";
    div.style.position = "relative"; // ì‚­ì œ ë²„íŠ¼ ìœ„ì¹˜ ì¡ê¸°

    div.onclick = () => openChecklist(checklist.id);

    div.innerHTML = `
  ${checklist.cover ? `<img src="${checklist.cover}" style="width:100%; max-height:250px; object-fit:contain;">` : ""}
  <h2>${checklist.title}</h2>
  <p>${checklist.description}</p>
`;

    // ì‚­ì œ ë²„íŠ¼ ì¶”ê°€
    const deleteBtn = document.createElement('button');
    deleteBtn.textContent = "ì‚­ì œ";
    deleteBtn.style.position = "absolute";
    deleteBtn.style.top = "10px";
    deleteBtn.style.right = "10px";
    deleteBtn.onclick = function(e) {
      e.stopPropagation(); // í´ë¦­ ì´ë²¤íŠ¸ ë§‰ê¸°
      deleteChecklist(checklist.id);
    };

    div.appendChild(deleteBtn);
    listDiv.appendChild(div);
  });
}

let editingChecklistId = null; // ì§€ê¸ˆ ìˆ˜ì •ì¤‘ì¸ ì²´í¬ë¦¬ìŠ¤íŠ¸ id ì €ì¥

function editChecklist() {
  const checklist = allChecklists.find(c => c.id === currentDetailId); // ìƒì„¸ í™”ë©´ì—ì„œ ë³´ê³  ìˆë˜ ì²´í¬ë¦¬ìŠ¤íŠ¸ id
  
  if (!checklist) {
    alert("ìˆ˜ì •í•  ì²´í¬ë¦¬ìŠ¤íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");
    return;
  }

  // ì»¤ìŠ¤í…€ ìƒì„±í™”ë©´ìœ¼ë¡œ ì´ë™
  showCreateView();

  // ê¸°ì¡´ ë°ì´í„° ì±„ì›Œë„£ê¸°
  document.getElementById('titleInput').value = checklist.title;
  document.getElementById('descInput').value = checklist.description || "";
  document.getElementById('coverImageInput').value = ""; // ì»¤ë²„ ì´ë¯¸ì§€ëŠ” ë³€ê²½ ì‹œ ìƒˆë¡œ ì„ íƒí•˜ê²Œ
  coverPreviewImage = checklist.cover || null; // ì»¤ë²„ í”„ë¦¬ë·°ë¥¼ ìƒˆë¡œ ì²˜ë¦¬ (optional)

  // í•­ëª©ë“¤ë„ ì±„ìš°ê¸°
  items = checklist.items.map(item => ({ ...item })); // ë³µì‚¬ë³¸
  renderItemList();

  editingChecklistId = checklist.id; // ìˆ˜ì •ì¤‘ì¸ ì²´í¬ë¦¬ìŠ¤íŠ¸ ID ì €ì¥
}

let currentDetailId = null; // í˜„ì¬ ìƒì„¸í™”ë©´ì— ì—´ë ¤ìˆëŠ” ì²´í¬ë¦¬ìŠ¤íŠ¸ ID
let coverPreviewImage = null; // (ì˜µì…˜) ì»¤ë²„ ì´ë¯¸ì§€ë¥¼ ì €ì¥

function openChecklist(id) {
  const checklist = allChecklists.find(c => c.id === id);
  if (!checklist) return;
  
  currentDetailId = id; // í˜„ì¬ ìƒì„¸ í™”ë©´ ì²´í¬ë¦¬ìŠ¤íŠ¸ id ì €ì¥
  document.getElementById('detailTitle').textContent = checklist.title;
  document.getElementById('detailDesc').textContent = checklist.description || "";

  if (checklist.cover) {
    document.getElementById('detailCover').src = checklist.cover;
    document.getElementById('detailCover').style.display = "block";
  } else {
    document.getElementById('detailCover').style.display = "none";
  }

  renderTaskList(checklist);
  showDetailView();
}


  function renderTaskList(checklist) {
    const taskListDiv = document.getElementById('taskList');
    taskListDiv.innerHTML = "";
    checklist.items.forEach((item, index) => {
      const div = document.createElement('div');
      div.style.border = "1px solid #ccc";
      div.style.borderRadius = "8px";
      div.style.padding = "5px";
      div.style.textAlign = "center";
      div.style.background = item.checked ? "#e0ffe0" : "#fff";
      div.style.position = "relative";

      div.onclick = function(e) {
        if (e.target.tagName.toLowerCase() !== 'button') {
          item.checked = !item.checked;
          localStorage.setItem('allChecklists', JSON.stringify(allChecklists));
          updateProgress(checklist);
          renderTaskList(checklist);
        }
      };

      if (item.image) {
        const img = document.createElement('img');
        img.src = item.image;
        img.style.width = "100%";
        img.style.height = "150px";
        img.style.objectFit = "contain";
        img.style.marginBottom = "5px";
        img.style.opacity = item.checked ? "1" : "0.4";
        img.style.transition = "opacity 0.3s ease";
        let pressTimer;
        img.addEventListener('mousedown', e => { e.stopPropagation(); pressTimer = setTimeout(() => openMemoModal(item), 600); });
        img.addEventListener('mouseup', () => clearTimeout(pressTimer));
        img.addEventListener('mouseleave', () => clearTimeout(pressTimer));
        img.addEventListener('touchstart', e => { e.stopPropagation(); pressTimer = setTimeout(() => openMemoModal(item), 600); });
        img.addEventListener('touchend', () => clearTimeout(pressTimer));
        div.appendChild(img);
      }

      const span = document.createElement('div');
      span.textContent = item.name;
      span.style.marginTop = "5px";
      div.appendChild(span);

      const editBtn = document.createElement('button');
      editBtn.textContent = "ìˆ˜ì •";
      editBtn.style.position = "absolute";
      editBtn.style.top = "5px";
      editBtn.style.right = "50px";
      editBtn.onclick = function(event) { event.stopPropagation(); editItem(checklist, item, index); };
      div.appendChild(editBtn);

      const deleteBtn = document.createElement('button');
      deleteBtn.textContent = "ì‚­ì œ";
      deleteBtn.style.position = "absolute";
      deleteBtn.style.top = "5px";
      deleteBtn.style.right = "5px";
      deleteBtn.onclick = function(event) { event.stopPropagation(); deleteItem(checklist, index); };
      div.appendChild(deleteBtn);

      taskListDiv.appendChild(div);
    });
    updateProgress(checklist);
  }

  function updateProgress(checklist) {
    const total = checklist.items.length;
    const completed = checklist.items.filter(item => item.checked).length;
    const percent = total === 0 ? 0 : Math.round((completed / total) * 100);
    document.getElementById('progressText').textContent = `ìˆ˜ì§‘ ì™„ë£Œ: ${completed} / ${total}ê°œ (${percent}%)`;
  }

  function editItem(checklist, item, index) {
    const newName = prompt("ìƒˆ í•­ëª© ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”:", item.name);
    if (newName !== null) { item.name = newName.trim(); }
    const newImageInput = document.createElement('input');
    newImageInput.type = 'file';
    newImageInput.accept = 'image/*';
    newImageInput.onchange = function() {
      const file = newImageInput.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          item.image = e.target.result;
          localStorage.setItem('allChecklists', JSON.stringify(allChecklists));
          renderTaskList(checklist);
        };
        reader.readAsDataURL(file);
      }
    };
    newImageInput.click();
    localStorage.setItem('allChecklists', JSON.stringify(allChecklists));
    renderTaskList(checklist);
  }

  function deleteItem(checklist, index) {
    if (confirm("ì •ë§ ì‚­ì œí• ê¹Œìš”?")) {
      checklist.items.splice(index, 1);
      localStorage.setItem('allChecklists', JSON.stringify(allChecklists));
      renderTaskList(checklist);
      updateProgress(checklist);
    }
  }

  function openMemoModal(item) {
    currentMemoItem = item;
    document.getElementById('modalImage').src = item.image;
    document.getElementById('memoInput').value = item.memo || "";
    document.getElementById('memoModal').style.display = "flex";
  }

  function closeMemoModal() {
    document.getElementById('memoModal').style.display = "none";
    currentMemoItem = null;
  }

  function saveMemo() {
    if (currentMemoItem) {
      currentMemoItem.memo = document.getElementById('memoInput').value.trim();
      localStorage.setItem('allChecklists', JSON.stringify(allChecklists));
      closeMemoModal();
    }
  }

function downloadBackup() {
  const dataStr = JSON.stringify(allChecklists, null, 2); // ì˜ˆì˜ê²Œ ì €ì¥
  const blob = new Blob([dataStr], { type: "application/json" });
  const url = URL.createObjectURL(blob);

  const link = document.createElement('a');
  link.href = url;
  
  // íŒŒì¼ ì´ë¦„ ì˜ˆì˜ê²Œ ë§Œë“¤ê¸° (ex: checklist-backup-20250428.json)
  const today = new Date();
  const fileName = `checklist-backup-${today.getFullYear()}${String(today.getMonth() + 1).padStart(2, '0')}${String(today.getDate()).padStart(2, '0')}.json`;
  
  link.download = fileName;
  link.click();

  URL.revokeObjectURL(url); // ë©”ëª¨ë¦¬ í•´ì œ
}

  window.onload = function() { renderChecklistList(); }

  function uploadBackup(event) {
  const file = event.target.files[0];
  if (!file) return;

  const reader = new FileReader();
  reader.onload = function(e) {
    try {
      const importedData = JSON.parse(e.target.result);

      if (!Array.isArray(importedData)) {
        alert("ì˜¬ë°”ë¥´ì§€ ì•Šì€ íŒŒì¼ì…ë‹ˆë‹¤. (ë°°ì—´ì´ ì•„ë‹˜)");
        return;
      }

      allChecklists = importedData;
      localStorage.setItem('allChecklists', JSON.stringify(allChecklists));
      renderChecklistList();
      alert("ë°±ì—… íŒŒì¼ì„ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤!");
    } catch (err) {
      console.error(err);
      alert("íŒŒì¼ì„ ì½ëŠ” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
    }
  };
  reader.readAsText(file);
}

</script>

</body>
</html>
